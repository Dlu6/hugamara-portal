; ===============================
;  Unified lean dialplan (fixed)
; ===============================

[globals]
BASECLIPREFIX=03233002
DEFAULT_DID_FALLBACK=0323300243
TRUNK_DOMAIN=siptrunk.cyber-innovative.com

[from-voip-provider]
switch => Realtime/from-voip-provider@voice_extensions

[internal]
switch => Realtime/internal@voice_extensions

[from-internal]
include => internal

; ---- 2-digit prefix -> DID (03233002XX) ----
exten => _4[3-9]X.,1,NoOp(Outbound w/ 2-digit DID prefix: ${EXTEN})
 same  => n,Set(P2=${EXTEN:0:2})                  ; e.g. 45
 same  => n,Set(CLI=${BASECLIPREFIX}${P2})        ; 0323300245
 same  => n,Set(DST=${EXTEN:2})                   ; strip prefix
 same  => n,Gosub(outbound-dial,s,1(${DST},${CLI}))
 same  => n,Hangup()

; ---- No prefix -> DEFAULT_DID (or fallback) ----
exten => _X.,1,NoOp(Outbound via DEFAULT_DID=${DEFAULT_DID})
 same  => n,Set(CLI=${IF($["${DEFAULT_DID}"!=""]?${DEFAULT_DID}:${DEFAULT_DID_FALLBACK})})
 same  => n,Gosub(outbound-dial,s,1(${EXTEN},${CLI}))
 same  => n,Hangup()

[outbound-dial]
; Args: ${ARG1}=dialed number, ${ARG2}=CLI DID (03233002XX)
exten => s,1,NoOp(Outbound Dial raw num=${ARG1} raw cli=${ARG2})

 ; Provider wants national format (07...)
 same  => n,Set(DST=${ARG1})
 same  => n,ExecIf($["${DST:0:4}" = "+256"]?Set(DST=0${DST:4}))
 same  => n,ExecIf($["${DST:0:3}" = "256"]?Set(DST=0${DST:3}))
 same  => n,ExecIf($["${DST:0:5}" = "00256"]?Set(DST=0${DST:5}))

 ; Set CLI (also drives dynamic From when trunk has no from_user)
 same  => n,Set(CALLERID(num)=${ARG2})
 same  => n,Set(CALLERID(name)=${ARG2})

 ; Helpful identity header (only if CLI is present)
 same  => n,Set(PJSIP_HEADER(remove,P-Preferred-Identity)=)
 same  => n,ExecIf($[${LEN(${ARG2})}>0]?Set(PJSIP_HEADER(add,P-Preferred-Identity)=<sip:${ARG2}@${TRUNK_DOMAIN}>))

 same  => n,NoOp(Dialing trunk with DST=${DST} CLI=${CALLERID(num)})
 same  => n,Set(CDR(type)=outbound))
 same  => n,Set(CDR(destination)=${DST})
 same  => n,Dial(PJSIP/${DST}@Hugamara_Trunk,60,tT)
 same  => n,Hangup()